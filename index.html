<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script type="text/javascript" src="http://cdn.webix.com/edge/webix.js"></script>
    <link rel="stylesheet" type="text/css" href="http://cdn.webix.com/edge/webix.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.materialdesignicons.com/2.7.94/css/materialdesignicons.css">
    <title>Webix | Task 1</title>
    <style>

        .label {
            color: #fff;
        }

        .side, .side > div {
            background-color: #EEEEEE;
        }

        .connected {
            text-align: center;
            color: green;
        }

        .footer__description {
            text-align: center;
        }
    </style>
</head>
<body>
    
    <script type="module" charset="utf-8">
        import { small_film_set } from './data/testdata.js';
        import { user_set } from './data/users.js';
        import { product_set } from './data/products.js';
        import { film_set } from './data/data.js';

        let header = {
            view: 'toolbar',
            height: 70,
            css: 'webix_dark',
            paddingX: 15,
            elements: [
                { view: 'label', label: "<span class='label'>My App</span>" },
                {},
                {
                    view: 'button',
                    id: 'Profile',
                    type: 'icon',
                    icon: 'mdi mdi-account',
                    maxWidth: 150,
                    css: 'webix_transparent',
                    label: 'Profile',
                    popup: 'profile_popup'
                }
            ]
        };

        let side = {
            css: 'side',
            gravity: 0.2,
            rows: [
                {
                    view: 'list',
                    borderless: true,
                    autoheight: true,
                    type: 'clean',
                    select: true,
                    on: {
                        onAfterSelect: function(id) {
                            $$(id).show();
                        }
                    },
                    data: [ 'Dashboard', 'Users', 'Products', 'Locations' ]
                },
                {},
                {
                    view: 'template',
                    height: 50,
                    css: 'connected',
                    borderless: true,
                    template: "<p><span class='webix_icon wxi-check'></span> Connected</p>"
                }
            ]
        };

        let resizer = { view: 'resizer' };

        let moviesTable = {
            view: 'datatable',
            id: 'movies_table',
            gravity: 3,
            scroll: 'y',
            select: true,
            scheme: {
                $init: function(obj) {
                    obj.votes = obj.votes.replace(',', '.');
                    obj.rating = obj.rating.replace(',', '.');
                }
            },
            columns: [
                { id: 'rank', header: '', css: 'rank', width: 50, sort: 'int' },
                { id: 'title', header: 'Film title', fillspace: true, sort: 'string' },
                { id: 'year', header: 'Released', sort: 'int' },
                {
                    id: 'votes',
                    header: 'Votes',
                    sort: 'int'
                },
                {
                    id: 'rating',
                    header: 'Ratings',
                    sort: 'int'
                }
            ],
            data: film_set
        };

        let buttons = [
            {
                view: 'button',
                css: 'webix_primary',
                value: 'Add New',
                click: function() {
                    if ($$('movies_form').validate()) {
                        save_row();
                    }
                }
            },
            {
                view: 'button',
                value: 'Clear',
                click: function() {
                    webix
                        .confirm({
                            text: 'Are you sure you want to clean the form?'
                        })
                        .then(
                            function() {
                                $$('movies_form').clearValidation();
                                $$('movies_form').clear();
                            },
                            function() {
                                webix.message('Rejected');
                            }
                        );
                }
            }
        ];

        let form = {
            view: 'form',
            id: 'movies_form',
            gravity: 1.5,
            elements: [
                { type: 'section', template: 'Icon buttons', borderless: true },
                { view: 'text', name: 'title', label: 'Title', invalidMessage: 'Please, enter the name of a movie' },
                {
                    view: 'text',
                    name: 'year',
                    label: 'Year',
                    invalidMessage: 'Enter year should be between 1970 and current year'
                },
                { view: 'text', name: 'rating', label: 'Rating', invalidMessage: 'Enter rating can not be empty or 0' },
                { view: 'text', name: 'votes', label: 'Votes', invalidMessage: 'Enter vote must be less than 100000' },
                { margin: '20', cols: webix.copy(buttons) },
                {}
            ],
            rules: {
                title: webix.rules.isNotEmpty,
                year: function(value) {
                    let currentYear = new Date().getFullYear();
                    return value > 1970 && value < currentYear;
                },
                votes: function(value) {
                    if (value != '') {
                        return value < 100000;
                    }
                    return false;
                },
                rating: function(value) {
                    if (webix.rules.isNumber(value)) {
                        return value != 0;
                    }
                    return false;
                }
            }
        };

        let main = {
            cells: [
                { id: 'Dashboard', cols: [ moviesTable, form ] },
                { id: 'Users', template: 'Users View' },
                { id: 'Products', template: 'Products View' },
                { id: 'Admin', template: 'Admin View' }
            ]
        };

        let footer = {
            id: 'footer',
            height: 60,
            css: 'footer__description',
            view: 'template',
            template:
                "<p>The software is provided by <a href='https://webix.com'>https://webix.com</a>. All rights reserved (c)</p>"
        };

        webix.ui({
            view: 'popup',
            id: 'profile_popup',
            body: {
                view: 'list',
                autoheight: true,
                data: [ 'Settings', 'Log out' ]
            }
        });

        webix.ui({
            rows: [
                header,
                {
                    cols: [ side, resizer, main ]
                },
                footer
            ]
        });

        $$('movies_table').attachEvent('onAfterSelect', function(id) {
            const item = $$('movies_table').getItem(id);
            $$('movies_form').setValues(item);
            $$('movies_form').clearValidation();
        });

        function save_row() {
            const values = $$('movies_form').getValues();
            if (values.id) {
                $$('movies_table').updateItem(values.id, values);
                webix.message({ type: 'success', text: 'The movie is updated' });
            } else {
                values.rank = $$('movies_table').count() + 1;
                $$('movies_table').add(values);
                webix.message({ type: 'success', text: 'The movie is added' });
            }
        }

      </script>
</body>
</html>